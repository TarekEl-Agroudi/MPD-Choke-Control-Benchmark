# MPD Benchmark: Standalone Executable (UDP Interface)

**Author:** Tarek El-Agroudi  
**Date:** 06-11-2025  
**Contact:** tareke@stud.ntnu.no / tarek@kelda.no

## Overview
This package contains the installer (`MPDBenchmarks_Installer.exe`) for the MPD Benchmark Simulator. This application enables the testing of external control algorithms **without requiring a Simulink license**.

It wraps high-fidelity physics FMUs in a C# environment and exposes a UDP interface. This allows researchers to implement controllers in **Python, C++, any other language, or run directly from industrial PLCs**.

### Features
* **"Lock-step" synchronization:** Ensures deterministic simulation results regardless of controller computation speed or network latency.
* **Optional "Real-time" mode:** For hardware-in-the-loop (HIL) testing.
* **Reference Implementations:** Includes controller examples in:
    * `Python/extCtrl.py`
    * `Matlab/extCtrl.m`
    * `C#/Program.cs`

## System Requirements

### Runtime (Simulator)
* **OS:** Windows 10/11 (64-bit)
* **Dependencies:** .NET Desktop Runtime (usually pre-installed on Windows)

### Reporting (Analysis)
* **MATLAB:** Required for generating PDF reports from CSV logs.
* **Control System Toolbox:** Required if analyzing Scenarios T6/T7.

## Quick Start

### Step 1: Install and Configure
1. Run `MPDBenchmarks_Installer.exe` to install the application.
2. Launch the installed `MPDBenchmarkTests.exe`.
3. **Configuration:**
   * Select Test Scenarios (e.g., "T1 Pressure Steps").
   * Select Test Well (e.g., "BM01 Land").
   * Select Log Directory (Where CSV logs will be saved).
   * Verify UDP Port (Default: `65000`).
4. **Real Time Checkbox:**
   * If testing an industrial PLC or slow controller, check **"Real Time"** to throttle the physics to wall-clock time.
   * Otherwise, leave unchecked for maximum simulation speed.

### Step 2: Start Simulation
Click **[RUN]**. The simulator will initialize and enter a "PAUSED" state, waiting for the first packet from your external controller.

### Step 3: Start External Controller
Launch your controller application (e.g., the provided Python, Matlab or C# examples). The simulation will begin immediately upon receiving the handshake packet (`k=0`).

### Step 4: Finish
The test runs automatically. Once complete, the simulator stops logging. Click **[ABORT]** if you wish to stop early.

## UDP Communication Protocol
The simulator acts as a **UDP Server**. The controller (Client) must initiate communication. Data is exchanged as **Little-Endian Double-Precision Floats**.

### Synchronization Logic
To ensure determinism, the simulator advances in discrete steps (Step size is 5 physics ticks, 50ms total).

1. **HANDSHAKE:** Controller sends command packet with step counter `k=0`.
2. **ADVANCE:** Simulator receives `k=0`, calculates physics, increments `k`.
3. **MEASURE:** Simulator sends measurement packet back with new `k`.
4. **CONTROL:** Controller receives measurement, calculates output, and sends command packet back using the **SAME** `k` it received.
5. **REPEAT:** Process loops until test completion.

### Packet Structure

#### 1. Command Packet (Controller -> Simulator)
**Size:** 6 Doubles (48 bytes)

| Index | Symbol | Description | Unit | Note |
| :--- | :--- | :--- | :--- | :--- |
| `[0]` | $k$ | Step counter | - | **Must match value received from Sim** |
| `[1]` | $z_{uA}$ | Choke 1 position cmd | 0-1 | **Control Signal** |
| `[2]` | $z_{uB}$ | Choke 2 position cmd | 0-1 | **Control Signal** |
| `[3]` | $w_{uA}$ | Choke 1 velocity ref | 1/s | **Control Signal** |
| `[4]` | $w_{uB}$ | Choke 2 velocity ref | 1/s | **Control Signal** |
| `[5]` | $E_{ctrl}$ | Controller Mode | - | Vel (0) / Pos (1) |

#### 2. Measurement Packet (Simulator -> Controller)
**Size:** 12 Doubles (96 bytes)

| Index | Symbol | Description | Unit |
| :--- | :--- | :--- | :--- |
| `[0]` | $t$ | Simulation Time | s |
| `[1]` | $k$ | Current Step Counter | - |
| `[2]` | $p_{c}^{r}$ | Choke Pressure Reference | bar |
| `[3]` | $p_c$ | Measured Choke Pressure | bar |
| `[4]` | $p_{stp}$ | Downhole/Standpipe Pressure | bar |
| `[5]` | $q_p$ | String Pump Flow | L/s |
| `[6]` | $q_{bl}$ | Back-pressure /boost Flow | L/s |
| `[7]` | $q_c$ | Choke Flow | L/s |
| `[8]` | $z_{cA}$ | Choke 1 position | 0-1 |
| `[9]` | $z_{cB}$ | Choke 2 position | 0-1 |
| `[10]` | $w_{cA}$ | Choke 1 velocity | 1/s |
| `[11]` | $w_{cB}$ | Choke 2 velocity | 1/s |

## Generating Reports
Analysis is performed in MATLAB using the logs generated by the EXE.

1. **Select Log Directory:** Point to the folder containing your `.CSV` files.
2. **Select Tests:** Choose which scenarios to analyze.
3. **Options:** Check "Open PDF" if you want the PDF to open automatically. Select theme.
4. **Click [Generate]**.

## Troubleshooting

**ISSUE: Simulator does not start after clicking Run.**
* **Solution:** Ensure no other application is blocking UDP Port 65000. Check Windows Firewall settings to allow the application access.

**ISSUE: Simulation runs extremely fast or freezes.**
* **Solution:** Check the "Lock-step" logic in your controller. If your controller does not echo the correct `k` back to the simulator, the simulator will discard the packet and wait.

**ISSUE: "NaN" values in measurement.**
* **Solution:** Ensure you are parsing the UDP bytes as **Little Endian** doubles. Ensure your controller is stable ;)
* **Hint:** The terminal window often gives useful insights into what is going on.
